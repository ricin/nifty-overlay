<html>
<head>
<!--<script type="text/javascript" src="https://getfirebug.com/firebug-lite.js#startOpened"></script>-->
<script src="http://localhost/socket.io/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="js/jquery.serialize-object.min.js"></script>
<script src="js/lodash.min.js"></script>
<!--<script src="js/xjs.js"></script>-->

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

<script>
var inputTemplate = {};
inputTemplate.text = _.template('<span><input name="<%=name%>" id="<%=id%>" type="text"></span>');
inputTemplate.textarea = _.template('<span><textarea name="<%=name%>" id="<%=id%>"></textarea></span>');
inputTemplate.number = _.template('<span><input name="<%=name%>" id="<%=id%>" type="number"></span>');
inputTemplate.image = _.template('<span><input class="image_field" name="<%=name%>" id="<%=id%>" type="text"><button class="local_image"><i class="fa fa-folder-open"></i></button></span>');
</script>

<script id="form_template" type="text/template">
	<form class="custom_form" data-id="<%= sourceId %>">
		<fieldset class="custom_fields">
			<legend>Custom Plugin Data</legend>
		</fieldset>
	</form>
</script>

<script id="group_template" type="text/template">
		<fieldset id="<%= group.id %>">
			<legend><%= group.label %></legend>
		</fieldset>
</script>

<script id="field_template" type="text/template">
	<div id="field-<%= i %>" class="field">
		<label for="<%= field.name %>"><%= field.label %></label>
		 <% if(field.tip) { %>
			<div class="tip_link">?<div class="tip_text"><div class="tip_link">?</div><h3><%= field.label%></h3><p><%= field.tip%></p></div></div>
		<% } %>
		<div class="field_wrap">
		 <%= inputTemplate[field.type]({name:field.name,id:field.id}) %>
		</div>
	<% if(field.copy) { %>
		<button class="copy_field" data-target-id="<%= i %>"><i class="fa fa-plus"></i></button>
	<% } %>
	</div>
</script>
<script id="scene-menu_template" type="text/template">
Scene: <select id="scene_menu">
<% scenes.forEach(function(scene,i){ %>
	<option value="<%=scene.num%>"<% if(activeScene == i+1){ %> selected<%}%>>
		<%=scene.name%>
	</option>
<% });%>
</select>
</script>

  <script>
/*var xjs = require('xjs');
var propsWindow = xjs.SourcePropsWindow.getInstance();
var extensionWindow = xjs.ExtensionWindow.getInstance();
var Source = xjs.Source;
var Scene = xjs.Scene;*/

var sourceName = 'butt' //temp until xjs integration

var socket = io.connect('http://localhost');

var mySource;
var sourceId = '12345' //temp until xjs integration
var configObj = {};
configObj.data = [];
var configDef;
var activeScene;

initConfigExtension();

function initConfigExtension(){
	socket.emit('xsplit_init', sourceName, function(initObj){
		configObj = initObj;
		configDef = configObj.configDef;
		makeFields(sourceId);
		if(configDef.controls) {
			makeControls();
		}
		if(configDef.resize || configDef.css) {
			makeDisplay();
		}
		updateFields(configObj,sourceId);
	});
}

function saveFields(sourceId) {
	var customData = $('form[data-id="'+sourceId+'"]').serializeObject();
	configObj.data = customData.data;
	if(configDef.resize) {
		configObj.resolution = {w:$('#res_width').val(),h:$('#res_height').val()};
	}
	if(configDef.css){
		configObj.css = $('#custom_css').val();
	}
	
	socket.emit('xsplit_update', {'source':sourceName,'data':configObj.data});
}

socket.on(sourceName, function(data){
    configObj.data = data;
    updateFields(configObj,sourceId);
});

 
/*if(xjs.Environment.isSourceConfig()){
	xjs.ready()
	.then(function() {
		propsWindow.useTabbedWindow({
			customTabs: ['Data'],
			tabOrder: ['Data','Layout', 'Color', 'Transition']
		});
	}).then(Source.getCurrentSource)
	.then(function(source) {
		mySource = source;
		return mySource.getId();
	})
	.then(function(myId){
		sourceId = myId;
		return mySource.loadConfig();
	}).then(function(config) {
		configObj = config;
		configDef = configObj.configDef;
		makeFields(sourceId);
		if(configDef.controls) {
			makeControls();
		}
		if(configDef.resize || configDef.css) {
			makeDisplay();
		}
		if(configObj.data.length == 0){
			configDef.fields.forEach(function(field,i){
				if(typeof field.default !== 'undefined'){
					configObj.data[i] = field.default;
				}
				else {
					configObj.data[i] = "";
				}
			});
		}
		updateFields(configObj,sourceId);
	});
}
if(xjs.Environment.isExtension()){
	xjs.ready().then(function(){
		Scene.getActiveScene().then(function(scene){
			scene.getSceneNumber().then(function(num) {
				activeScene = num;
				initConfigExtension(scene);
			});
		});
	});
}
extensionWindow.on('scene-load', function(sceneNum){
	xjs.ready().then(function(){
		Scene.getActiveScene().then(function(scene){
			scene.getSceneNumber().then(function(num) {
				activeScene = num;
				initConfigExtension(scene);
			});
		});
	});
});


function initConfigExtension(currentScene){
$('#wrapper').empty();
makeSceneMenu();
Scene.initializeScenes().then(function(val) {
	if(val===true) {
		currentScene.getSources().then(function(sources){
		sources.forEach(function(source,i){
			var sourceId;
			source.getType().then(function(type){

				if(type == 8){
				 source.getId().then(function(myId){
					sourceId = myId;
					return source.loadConfig();
				 }).then(function(config){
						if(typeof config.configDef !== 'undefined'){
							configObj = config;
							configDef = configObj.configDef;
							makeFields(sourceId);
							if(configDef.controls) {
								makeControls();
							}
							if(configObj.data.length == 0){
								configDef.fields.forEach(function(field,i){
									if(typeof field.default !== 'undefined'){
										configObj.data[i] = field.default;
									}
									else {
										configObj.data[i] = "";
									}
								});
							}
							updateFields(configObj, sourceId);
						}
					});
				}
			});
		});
	});
	}
	});
}
*/
$(function(){
	$('body').on('click','.configSubmit',function(event) {
		event.preventDefault();
		var sourceId = $(this).parents('form').data('id');
		saveFields(sourceId);
	});
	$("body").on("keypress", "input,textarea",function( event ) {
		if ( event.which == 13 && !event.shiftKey) {
			event.preventDefault();
			var sourceId = $(this).parents('form').data('id');
			saveFields(sourceId);
		}
	});
	$("body").on("change", "input,textarea",function( event ) {
			var sourceId = $(this).parents('form').data('id');
			saveFields(sourceId);
	});
	$('body').on('click','#controls button',function(event){
		configObj.control = $(this).data('targetFunc');
		mySource.applyConfig(configObj);
	});
	$('body').on('click','.local_image',function(event){
		event.preventDefault();
		var target = $(this).prevAll('input');
		//var sourceId = $(this).parents('form').data('id');
		xjs.IO.openFileDialog({fileMustExist:true},{name:"Image Files",extensions:['jpg','bmp','png','gif']}).then(function(path){
			target.val(path[0]);
		});
	});
	$('body').on('click','.copy_field',function(event){
		event.preventDefault();
		var id = $(this).data('targetId');
		var sourceId = $(this).parents('form').data('id');
		makeCopyField(id,sourceId);
		renumberCopyField(id, sourceId);
	});
	$('body').on('click','.del_field',function(event){
		event.preventDefault();
		var id = $(this).data('targetId');
		var num = $(this).data('fieldNum');
		var sourceId = $(this).parents('form').data('id');
		$('form[data-id="'+sourceId+'"] #data-'+id+'-'+num).parent('span').remove();
		renumberCopyField(id, sourceId);
	});
	$('body').on('change','#scene_menu',function(event){
		event.preventDefault();
		activeScene = $(this).val();
		xjs.ready().then(function(){
			initConfigExtension(Scene.getById(activeScene));
		});
	});
 });
 
 function makeGroups(sourceId) {
	_.forEach(configDef.groups,function(group, i){
		var groupTemplate = _.template($("#group_template").html());
		$('form[data-id="'+sourceId+'"] .custom_fields').append(groupTemplate({group:group}));
	});
 }
 function makeSceneMenu(){
 	var sceneMenuTemplate = _.template($("#scene-menu_template").html());
	var sceneNumbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
	var promises = sceneNumbers.map(function(number) {
	  return new Promise(function(resolve) {
		Scene.getById(number).getName().then(function(name) {
		var scene = {name:name,num:number};
		  resolve(scene);
		});
	  });
	});
	Promise.all(promises).then(function(scenes) {
		$('#wrapper').prepend(sceneMenuTemplate({scenes:scenes,activeScene:activeScene}));
	});
 }
function makeFields(sourceId) {
	var formTemplate = _.template($("#form_template").html());
	$('#wrapper').append(formTemplate({sourceId:sourceId}));
	makeGroups(sourceId);
	_.forEach(configDef.fields,function(field, i){
		field.id = 'data-'+i;
		field.name = 'data['+i+']';
		if(field.copy){
			field.id += '-0';
			field.name += '[0]';
		} 
		var fieldTemplate = _.template($("#field_template").html());
		$('form[data-id="'+sourceId+'"] .custom_fields '+field.group).append(fieldTemplate({inputTemplate:inputTemplate,field:field,i:i}));
			
	});
	$('form[data-id="'+sourceId+'"] .custom_fields').append('<div class="buttons"><button class="configSubmit" value="Save" >Save</button></div>');
}

function makeCopyField(id, sourceId){
	var num = $('form[data-id="'+sourceId+'"] #field-'+id+' input,'+' form[data-id="'+sourceId+'"] #field-'+id+' textarea').length;
	var field = configDef.fields[id];
	
	var template = _.template('<%= inputTemplate[field.type]({name:"",id:""}) %>');
	$('form[data-id="'+sourceId+'"] #field-'+id+' .field_wrap').append(template({field:field}));
}
function renumberCopyField(id, sourceId){
$('form[data-id="'+sourceId+'"] #field-'+id+' .del_field').remove();
var fields = $('form[data-id="'+sourceId+'"] #field-'+id+' input,'+'form[data-id="'+sourceId+'"] #field-'+id+' textarea');
	fields.each(function(num){
		var fieldId = 'data-'+id+'-'+num;
		var fieldName = 'data['+id+']['+num+']';
		$(this).attr({'name':fieldName,'id':fieldId});
		if(fields.length >1){
			$('<button data-target-id='+id+' data-field-num='+num+'><i class="fa fa-minus"></i></button>').addClass('del_field').insertAfter($('form[data-id="'+sourceId+'"] #'+fieldId));
		}
	});
}
function makeControls(){
	var controls_set = $('<fieldset id="controls" />');
	$('<legend />').html('Controls').appendTo(controls_set);
	if(typeof configDef.controls.play !== 'undefined'){
		$('<button />').html('<i class="fa fa-play"></i>').data({targetFunc:configDef.controls.play}).appendTo(controls_set);
	}
	if(typeof configDef.controls.pause !== 'undefined'){
		$('<button />').html('<i class="fa fa-pause"></i>').data({targetFunc:configDef.controls.pause}).appendTo(controls_set);
	}
	if(typeof configDef.controls.rewind !== 'undefined'){
		$('<button />').html('<i class="fa fa-step-backward"></i>').data({targetFunc:configDef.controls.rewind}).appendTo(controls_set);
	}
	controls_set.prependTo('body');
}
function makeDisplay(){
	var display_set = $('<fieldset id="display" />');
	$('<legend />').html('Display').appendTo(display_set);
	if(configDef.resize){
		var wrapper = $('<div />').html(' x ').appendTo(display_set);
		$('<input />').attr({name:'res_width',id:'res_width',type:'text'}).prependTo(wrapper);
		$('<input />').attr({name:'res_height',id:'res_height',type:'text'}).appendTo(wrapper);
		var tip_link = $('<div>?</div>').addClass('tip_link').prependTo(wrapper);
		$('<div />').html('<div class="tip_link">?</div><h3>'+'Custom Resolution'+'</h3><p>'+'Enter Custom Resolution or 0 for auto resolution').addClass('tip_text').appendTo(tip_link);
		$('<label />').html('Resolution').prependTo(wrapper);
	}
	if(configDef.css){
		var wrapper = $('<div />').appendTo(display_set);
		$('<textarea />').attr({name:'custom_css',id:'custom_css'}).appendTo(wrapper);
		var tip_link = $('<div>?</div>').addClass('tip_link').prependTo(wrapper);
		$('<div />').html('<div class="tip_link">?</div><h3>'+'Custom CSS'+'</h3><p>'+'Enter Custom CSS rules').addClass('tip_text').appendTo(tip_link);
		$('<label />').html('CSS').prependTo(wrapper);
	}
	display_set.appendTo('body');
}


/*function saveFields(sourceId) {
	var customData = $('form[data-id="'+sourceId+'"]').serializeObject();
	configObj.data = customData.data;
	if(configDef.resize) {
		configObj.resolution = {w:$('#res_width').val(),h:$('#res_height').val()};
	}
	if(configDef.css){
		configObj.css = $('#custom_css').val();
	}
	
	if(xjs.Environment.isSourceConfig()){
	Source.getCurrentSource().then(function (mySource){
		mySource.requestSaveConfig(configObj);
		//propsWindow.closeConfig();
		});
	}
	else {
		var mySource;
		var sourceCName;
		Scene.searchSourcesById(sourceId).then(function (source){
			mySource = source;
			return mySource.getCustomName();
			}).then(function(cname){
				sourceCName = cname;
				return mySource.getName();
			}).then(function (name){
				var re = /.*[\\\/](.*)/gmi;
				var result = re.exec(name);
				return Scene.searchSourcesByName(result[1]);
			}).then(function(sources){
				console.log(sources);
				sources.forEach(function(source,i){
					source.getCustomName().then(function(name){
						if(name == sourceCName){
							source.requestSaveConfig(configObj);
						}
					});
				});
			});
		}

}*/

function updateFields(configObj, sourceId){
	configObj.data.forEach(function (value, i){
		if(typeof value === 'object'){
			value.forEach(function(sub,num){
				if(num>0){
					makeCopyField(i,sourceId);
				}
				
			});
			renumberCopyField(i,sourceId);
			value.forEach(function(sub,num){
				$('form[data-id="'+sourceId+'"] #data-'+i+'-'+num).val(sub);
			});
		}
		else{
			$('form[data-id="'+sourceId+'"] #data-'+i).val(value);
		}	
	});
	if(configDef.resize) {
		$('#res_width').val(configObj.resolution.w);
		$('#res_height').val(configObj.resolution.h); 
	}
	if(configDef.css){
		$('#custom_css').val(configObj.css);		
	}
}

	
  </script>
  <style>
  * { -webkit-box-sizing: border-box; outline:0}
            html { font-family:Arial, Verdana, Helvetica, sans-serif; text-align:left; background:#313131; border:none; outline:none; margin:0; padding:0; white-space:nowrap }
			body { position:relative; font-family:inherit; display:block;font-size:12px; color:#ccc; margin:10px 0 0 0; padding:0 }
			fieldset {position:relative;background-color:#212121;border:1px solid #999; color:#ccc;text-align:left; margin:32px 2px 2px 2px; padding:2px;}
			legend {position:absolute;top: -20px;}
			label { display:inline-block; font-size:11px; margin:0; padding:0 5px 0 0; width:76px;text-align:right;vertical-align:text-top}
			.tip_link {position:relative;display:inline-block; width:15px;height:15px;background-color:#393939;color:#000;font-weight:bold;text-align:center;margin:0 3px 0 0;vertical-align:middle;border:1px solid #000;}
			.tip_text {cursor:help;z-index:100;position:absolute;top:-3px; left:-3px;background:#000;color:#ccc;display:none;padding:3px;width:250px;max-height:120px;font-weight:normal;text-align:left;white-space:normal;}
			.tip_text h3 {display:inline-block;color:#0096d6;font-weight:bold;margin:0;padding:0}
			.tip_text .tip_link {display:inline-block;background-color:#0096d6;padding:0;margin:0 3px 0 0;vertical-align:top;}
			.tip_link:hover .tip_text {display:block;}
			.field_wrap {display:inline-block;width:auto;white-space:normal;vertical-align:top;}
			.field_wrap span {position:relative;}
			input[type=text],input[type=number],textarea {font-family:Arial, Verdana, Helvetica, sans-serif;background-color:#393939;border:1px solid #000;color:#999; padding:3px;width:197px;margin:0 0 2px 0;}
			input[type=number]{width:50px;}
			input.image_field {padding:3px 30px 3px 3px;}
			input::-webkit-inner-spin-button {opacity: 1;}
			#display input[type=text]{display:inline-block;font-family:Arial, Verdana, Helvetica, sans-serif;background-color:#393939;border:1px solid #000;color:#999; padding:3px;width:60px;}
			textarea {height:80px;vertical-align:bottom;resize:vertical;}
}
			input:focus, textarea:focus {background-color:#4c4c4c; border:1px solid #000;}
			.field {padding:3px 0;float:left;}
			button {background-color:#000;border:1px solid #555;color:#fff;font-size:11px;padding:0 5px;margin:0 0 2px 2px;height:23px;}
			button:hover {background-color:#043151;border-color:#fff;cursor:pointer}
			button.copy_field {vertical-align:bottom;margin:0 0 2px 0;}
			button.local_image {font-size:9px; height:16px; position:absolute;top:-1px;left:168px;}
			.buttons {text-align:right;clear:both;}
			.buttons button {text-align:right;clear:both; margin:5px;}
 </style>
</head>
<body>
<div id="wrapper"></div>
</body>
</html>